<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>SimNation - Active Lots and Players</title>
    <script src="https://kit.fontawesome.com/aa64a4e171.js" crossorigin="anonymous"></script>
    <style>

    body {
        font-family: Arial, sans-serif;
        background-color: #1b1b1b; 
        color: #f4f4f4; 
        margin: 0;
        padding: 20px;
    }

    h1, h3 {
        text-align: center;
        color: #ff7518; 
        font-size: 32px;
    }

    #main-container {
        display: flex;
        justify-content: space-between;
        gap: 1%;
    }

    .container {
        width: 49%;
        background: #333; 
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); 
        padding: 10px;
        display: flex;
        flex-direction: column;
        margin-bottom: 20px; /* Add spacing between rows */
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    th, td {
        padding: 10px;
        border-bottom: 1px solid #555; 
        text-align: left;
    }

    th {
        background-color: #ff7518; 
        color: white;
    }

    tr:hover {
        background-color: #444; 
        color: #ff7518; 
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .scrollable {
        height: 400px;
        overflow-y: auto;
        flex-grow: 1;
    }

    #tempoSim {
        text-align: center;
        font-size: 18px;
        margin-bottom: 20px;
        color: #ff7518; 
    }

    #rewards {
        margin-top: 30px;
        text-align: center;
    }

    #rewards-dropdown {
        background: #333; 
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        overflow-y: auto;
        max-height: 400px;
        width: 80%;
        margin: 0 auto;
    }

    @media (max-width: 768px) {
        #main-container {
            flex-direction: column;
        }
        .container {
            width: 100%;
            margin-bottom: 20px;
        }
    }

    .hidden {
        display: none;
    }

    /* Show icon on row hover */
    table tr {
        position: relative;
    }

    table tr:hover::after {
        content: '';
        position: absolute;
        width: 20px; /* Adjust size */
        height: 20px; /* Adjust size */
        background-image: url('https://cdn-icons-png.flaticon.com/512/685/685844.png'); 
        background-size: contain;
        background-repeat: no-repeat;
        right: 10px; /* Adjust position */
        top: 10px; /* Adjust position */
        animation: fade-in 0.3s; 
    }

    /* Fade-in animation */
    @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    </style>
    <script>
        async function displayLotInfo(lotId) {
            const url = `https://api.allorigins.win/get?url=${encodeURIComponent(`http://simnationserver.com:9000/userapi/city/1/i${lotId}.json`)}`;
        
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                const lotData = JSON.parse(data.contents); // Parse the JSON data from the response

                // Mapping for lot categories
                const categoryMapping = {
                    1: 'Money',
                    2: 'Money',
                    3: 'Skills',
                    4: 'Service',
                    5: 'Store',
                    6: 'Skills',
                    7: 'Welcome',
                    8: 'Games',
                    9: 'Offbeat',
                    10: 'Residential',
                    11: 'Community'
                };

                // Fetch owner's name using owner_id
                const ownerNameUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(`http://simnation.ddns.net:9000/userapi/avatars/${lotData.owner_id}`)}`;
                const ownerResponse = await fetch(ownerNameUrl);
                if (!ownerResponse.ok) {
                    throw new Error('Failed to fetch owner name');
                }
                const ownerData = await ownerResponse.json();
                const ownerDataParsed = JSON.parse(ownerData.contents);
                const ownerName = ownerDataParsed.name; // Get the owner's name

                // Replace \r\n with <br> in description
                const formattedDescription = (lotData.description || 'No description available.').replace(/\r\n/g, '<br>');

                // Get the list of known Sims inside the lot
                const playersContainer = document.getElementById('players');
                const playersRows = Array.from(playersContainer.querySelectorAll('tr'));

                const knownSims = playersRows
                    .filter(row => row.querySelector('.hidden:nth-child(3)').textContent === lotId.toString()) // Match lotId with player's "location"
                    .map(row => row.querySelector('td').textContent); // Get the player's name

                // Display all information in the Console
                const consoleContent = document.getElementById('console-content');
                consoleContent.innerHTML = ''; // Clear placeholder
                consoleContent.innerHTML = `
                    <div style="background-color: #ff7518; padding: 10px; color: white; text-align: center; font-size: 20px;">
                        ${lotData.name}
                    </div>
                    <img src="https://images.weserv.nl/?url=simnationserver.com:9000/userapi/city/1/${lotId}.png" alt="${lotData.name}" style="width: 200px; height: 200px; border-radius: 8px; border: 3px solid #ff7518; display: block; margin: 10px auto;">
                    <p><strong>Description:</strong> ${formattedDescription}</p>
                    <p><strong>Lot Type:</strong> ${categoryMapping[lotData.category] || 'Unknown'}</p>
                    <p><strong>Owner:</strong> ${ownerName || 'Unknown'}</p>
                    <p><strong>Known Sims Inside:</strong> ${knownSims.length > 0 ? knownSims.join(', ') : 'None'}</p>
                    <p>There may be sims inside with their location hidden.</p>
                `;
            } catch (error) {
                console.error('Failed to fetch lot details:', error);
                document.getElementById('console-content').innerHTML = 'Error loading lot details.';
            }
        }

        async function displayPlayerInfo(avatarId) {
            const url = `https://api.allorigins.win/get?url=${encodeURIComponent(`http://simnationserver.com:9000/userapi/avatars/${avatarId}`)}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                const playerData = JSON.parse(data.contents); // Parse the JSON data from the response

                // Calculate player age from Unix timestamp
                const creationDate = new Date(playerData.date * 1000); // Convert to milliseconds
                const currentDate = new Date();
                const ageInDays = Math.floor((currentDate - creationDate) / (1000 * 60 * 60 * 24)); // Calculate age in days

                // Get the player's location from the Sims Online table
                const playersContainer = document.getElementById('players');
                const locationRow = Array.from(playersContainer.querySelectorAll('tr'))
                    .find(row => row.querySelector('.hidden:nth-child(2)').textContent === avatarId.toString()); // Match avatar ID
                const playerLocation = locationRow ? locationRow.querySelector('td:nth-child(4)').textContent : 'Unknown'; // Get location name

                // Replace \r\n with <br> in description
                const formattedDescription = (playerData.description || 'No description available.').replace(/\r\n/g, '<br>');

                // Display all information in the Console
                const consoleContent = document.getElementById('console-content');
                consoleContent.innerHTML = ''; // Clear placeholder
                consoleContent.innerHTML = `
                    <div style="background-color: #ff7518; padding: 10px; color: white; text-align: center; font-size: 20px;">
                        ${playerData.name}
                    </div>
                    <p><strong>Description:</strong> ${formattedDescription}</p>
                    <p><strong>Age:</strong> ${ageInDays} days old</p>
                    <p><strong>Location:</strong> ${playerLocation}</p>
                `;
            } catch (error) {
                console.error('Failed to fetch player details:', error);
                document.getElementById('console-content').innerHTML = 'Error loading player details.';
            }
        }

        // Initialize the dashboard
        async function init() {
            tempoSim();
            await loadOnlinePlayers();
            await loadLots();
            await fetchRewards(); // Load rewards data
        }

        window.onload = init; // Initialize on window load
    </script>
</head>
<body>
    <h1><i class="fa-solid fa-ghost"></i> SimNation Dashboard - Halloween Version <i class="fa-solid fa-ghost"></i></h1>
    <div id="tempoSim">Time in Eldorado: Loading time...</div>
    <p style="font-style: italic; text-align: center;">Data is refreshed every minute for the most current information.</p>
    <div id="main-container">
        <div class="container">
            <h3 id="players-title"><i class="fa-solid fa-hat-wizard"></i> Sims Online: 0 <i class="fa-solid fa-hat-wizard"></i></h3>
            <div class="scrollable" id="players"></div>
        </div>
        <div class="container">
            <h3 id="lots-title"><i class="fa-solid fa-spider"></i> Active Lots <i class="fa-solid fa-spider"></i></h3>
            <div class="scrollable" id="lots"></div>
        </div>
    </div>

    <div id="bottom-container" style="display: flex; justify-content: space-between; gap: 1%;">
        <div class="container">
            <h3><i class="fa-solid fa-wand-sparkles"></i> Current Patreon Rewards <i class="fa-solid fa-wand-sparkles"></i></h3>
            <div class="scrollable" id="rewards-container">
                <table id="rewards-table">
                    <thead>
                        <tr>
                            <th>Reward Name</th>
                            <th>Image</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Content will be populated dynamically by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="container">
            <h3><i class="fa-solid fa-book-skull"></i> Console <i class="fa-solid fa-book-skull"></i></h3>
            <div id="console-content" style="text-align: center; font-size: 18px; color: #ff7518;">
                Select a Sim or a Lot to see more information.
            </div>
        </div>
    </div>
</body>
</html>
