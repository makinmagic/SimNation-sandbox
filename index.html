<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://blogimages6.wordpress.com/wp-content/uploads/2024/10/favicon-48x48-1-e1728676952232.png" type="image/png">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>SimNation Dashboard - Halloween Version</title>
    <script src="https://kit.fontawesome.com/aa64a4e171.js" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1b1b1b;
            color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        h1, h3 {
            text-align: center;
            color: #ff7518;
            font-size: 32px;
        }

        #main-container, #bottom-container {
            display: flex;
            justify-content: space-between;
            gap: 1%;
        }

        .container {
            width: 49%;
            background: #333;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            padding: 10px;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #555;
            text-align: left;
        }

        th {
            background-color: #ff7518;
            color: white;
            cursor: pointer;
        }

        /* Column width adjustments */
        #playersTable th:nth-child(1), #lotsTable th:nth-child(1) { width: 30%; }
        #playersTable th:nth-child(3), #lotsTable th:nth-child(2) { width: 20%; }
        #playersTable th:nth-child(5), #lotsTable th:nth-child(3) { width: 25%; }

        tr:hover {
            background-color: #444;
            color: #ff7518;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .scrollable {
            height: 400px;
            overflow-y: auto;
            flex-grow: 1;
        }

        #tempoSim {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            color: #ff7518;
        }

        /* Responsive styling */
        @media (max-width: 768px) {
            #main-container, #bottom-container {
                flex-direction: column;
            }

            .container {
                width: 100%;
                margin-bottom: 20px;
            }
        }
    </style>

    <script>
        function sortTable(tableId, colIndex, isNumeric) {
            const table = document.getElementById(tableId);
            const rowsArray = Array.from(table.querySelector("tbody").rows);

            rowsArray.sort((a, b) => {
                const aVal = a.cells[colIndex].textContent.trim();
                const bVal = b.cells[colIndex].textContent.trim();
                return isNumeric ? parseFloat(aVal) - parseFloat(bVal) : aVal.localeCompare(bVal);
            });

            rowsArray.forEach(row => table.querySelector("tbody").appendChild(row));
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelector("#playersTable th:nth-child(3)").onclick = () => sortTable("playersTable", 2, true); // Age
            document.querySelector("#playersTable th:nth-child(5)").onclick = () => sortTable("playersTable", 4, false); // Location
            document.querySelector("#lotsTable th:nth-child(2)").onclick = () => sortTable("lotsTable", 1, true); // Sims Inside
            document.querySelector("#lotsTable th:nth-child(3)").onclick = () => sortTable("lotsTable", 2, false); // Lot Type
        });

        async function loadLotName(lotId) {
            if (lotId === 0) return 'Unknown';
            const lotData = await fetch('https://web-production-3227.up.railway.app/http://simnation.ddns.net:9000/userapi/city/1/city.json');
            return lotData ? lotData.name : 'N/A';
        }

        async function loadActiveLots() {
            try {
                const response = await fetch('https://web-production-3227.up.railway.app/http://simnation.ddns.net:9000/userapi/city/1/city.json');
                const activeLotsData = await response.json();
                const lotMapping = {};
                const names = activeLotsData.names;
                const reservedLots = activeLotsData.reservedLots;

                reservedLots.forEach((id, index) => {
                    lotMapping[id] = names[index];
                });

                return lotMapping;
            } catch (error) {
                console.error('Failed to load active lots:', error);
                return {};
            }
        }

        async function loadOnlinePlayers() {
            try {
                const playersTitle = document.getElementById('players-title');
                if (playersTitle) {
                    playersTitle.innerHTML = `<i class="fa-solid fa-hat-wizard"></i> Sims Online: Loading... <i class="fa-solid fa-hat-wizard"></i>`;
                }

                const response = await fetch('https://web-production-3227.up.railway.app/http://simnation.ddns.net:9000/userapi/avatars/online');
                const onlineData = await response.json();
                const playersContainer = document.getElementById('players');
                playersContainer.innerHTML = '';

                const lotMapping = await loadActiveLots();
                const sortedAvatars = onlineData.avatars.sort((a, b) => a.name.localeCompare(b.name));

                const fetchPlayerDetailsPromises = sortedAvatars.map(avatar =>
                    fetch(`https://web-production-3227.up.railway.app/http://simnation.ddns.net:9000/userapi/avatars/${avatar.avatar_id}`).then(response => response.json())
                );

                const playerDetailsArray = await Promise.all(fetchPlayerDetailsPromises);

                let tableHtml = `
                    <table id="playersTable">
                        <thead>
                            <tr>
                                <th>Sim</th>
                                <th class="hidden">ID</th>
                                <th>Age</th>
                                <th class="hidden">Location ID</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody>`;

                sortedAvatars.forEach((avatar, index) => {
                    const lotName = lotMapping[avatar.location] || 'Unknown';
                    const playerDetails = playerDetailsArray[index];
                    const creationDate = new Date(playerDetails.date * 1000);
                    const currentDate = new Date();
                    const ageInDays = Math.floor((currentDate - creationDate) / (1000 * 60 * 60 * 24));

                    tableHtml += `
                    <tr data-avatar-id="${avatar.avatar_id}">
                        <td>${avatar.name}</td>
                        <td class="hidden">${avatar.avatar_id}</td>
                        <td>${ageInDays} days</td>
                        <td class="hidden">${avatar.location}</td>
                        <td>${lotName}</td>
                    </tr>`;
                });

                tableHtml += `
                        </tbody>
                    </table>`;
                playersContainer.innerHTML = tableHtml;

                document.querySelectorAll("#playersTable tbody tr").forEach(row => {
                    row.onclick = () => displayPlayerInfo(row.dataset.avatarId);
                });

                if (playersTitle) {
                    playersTitle.innerHTML = `<i class="fa-solid fa-hat-wizard"></i> Sims Online: ${onlineData.avatars_online_count} <i class="fa-solid fa-hat-wizard"></i>`;
                }

            } catch (error) {
                console.error('Failed to load online players:', error);
                document.getElementById('players').innerHTML = 'Error loading online players.';
            }
        }

        const categoryMapping = {
            1: 'Money',
            2: 'Money',
            3: 'Romance',
            4: 'Service',
            5: 'Store',
            6: 'Skills',
            7: 'Welcome',
            8: 'Games',
            9: 'Entertainment',
            10: 'Residential',
            11: 'Community'
        };

        async function loadLots() {
            try {
                const response = await fetch('https://web-production-3227.up.railway.app/http://simnation.ddns.net:9000/userapi/city/1/city.json');
                const jsonData = await response.json();

                const activeLots = jsonData.activeLots;
                const onlineCounts = jsonData.onlineCount;
                const lotMapping = {};
                for (let i = 0; i < jsonData.reservedLots.length; i++) {
                    lotMapping[jsonData.reservedLots[i]] = jsonData.names[i];
                }

                const lotsContainer = document.getElementById('lots');
                lotsContainer.innerHTML = '';

                let lotsData = activeLots.map((lotID, index) => {
                    return {
                        name: lotMapping[lotID] || lotID,
                        count: onlineCounts[index],
                        id: lotID
                    };
                });

                lotsData.sort((a, b) => b.count - a.count);

                const fetchLotDetailsPromises = lotsData.map(lot =>
                    fetch(`https://web-production-3227.up.railway.app/http://simnationserver.com:9000/userapi/city/1/i${lot.id}.json`).then(response => response.json())
                );

                const lotDetailsArray = await Promise.all(fetchLotDetailsPromises);

                let tableHtml = `
                    <table id="lotsTable">
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>Sims Inside</th>
                                <th>Lot Type</th>
                            </tr>
                        </thead>
                        <tbody>`;

                lotsData.forEach((lot, index) => {
                    if (lot.count > 0) {
                        const lotDetails = lotDetailsArray[index];
                        const lotType = categoryMapping[lotDetails.category] || 'Unknown';

                        tableHtml += `
                            <tr data-lot-id="${lot.id}">
                                <td>${lot.name}</td>
                                <td>${lot.count}</td>
                                <td>${lotType}</td>
                            </tr>`;
                    }
                });

                tableHtml += `
                        </tbody>
                    </table>`;
                lotsContainer.innerHTML = tableHtml;

                document.querySelectorAll("#lotsTable tbody tr").forEach(row => {
                    row.onclick = () => displayLotInfo(row.dataset.lotId);
                });

            } catch (error) {
                console.error('Error loading lots:', error);
                document.getElementById('lots').innerHTML = 'Error loading lots.';
            }
        }

        // Functions displayPlayerInfo and displayLotInfo will be defined in Part 2
    </script>
</head>
<body>
    <h1><i class="fa-solid fa-ghost"></i> SimNation Dashboard - Halloween Version <i class="fa-solid fa-ghost"></i></h1>
    <div id="tempoSim">Time in Eldorado: Loading time...</div>

    <div id="main-container">
        <!-- Sims Online Container -->
        <div class="container">
            <h3 id="players-title"><i class="fa-solid fa-hat-wizard"></i> Sims Online: 0 <i class="fa-solid fa-hat-wizard"></i></h3>
            <div class="scrollable" id="players">
                <!-- Players Table will be populated dynamically -->
            </div>
        </div>

        <!-- Active Lots Container -->
        <div class="container">
            <h3 id="lots-title"><i class="fa-solid fa-spider"></i> Active Lots <i class="fa-solid fa-spider"></i></h3>
            <div class="scrollable" id="lots">
                <!-- Lots Table will be populated dynamically -->
            </div>
        </div>
    </div>

    <div id="bottom-container">
        <!-- Current Patreon Rewards Container -->
        <div id="rewards-container" class="container">
            <h3><i class="fa-solid fa-wand-sparkles"></i> Current Patreon Rewards <i class="fa-solid fa-wand-sparkles"></i></h3>
            <div class="scrollable">
                <table id="rewards-table">
                    <thead>
                        <tr>
                            <th>Reward Name</th>
                            <th>Image</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rewards content populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Console Container -->
        <div id="console-container" class="container">
            <h3><i class="fa-solid fa-book-skull"></i> Console <i class="fa-solid fa-book-skull"></i></h3>
            <div id="console-content">
                <p style="text-align: center; color: #ccc;">Select a Sim, Lot, or Reward to see more information.</p>
            </div>
        </div>
    </div>

    <script>
        // Display player info in the console
        async function displayPlayerInfo(avatarId) {
            const response = await fetch(`https://web-production-3227.up.railway.app/http://simnation.ddns.net:9000/userapi/avatars/${avatarId}`);
            const player = await response.json();

            const consoleContent = document.getElementById('console-content');
            consoleContent.innerHTML = `
                <div style="text-align: center; background-color: #ff7518; padding: 10px; color: white;">
                    <h3>${player.name}</h3>
                    <p>Age: ${Math.floor((new Date() - new Date(player.date * 1000)) / (1000 * 60 * 60 * 24))} days</p>
                    <p>Location ID: ${player.location || "N/A"}</p>
                </div>
            `;
        }

        // Display lot info in the console
        async function displayLotInfo(lotId) {
            const response = await fetch(`https://web-production-3227.up.railway.app/http://simnation.ddns.net:9000/userapi/city/1/i${lotId}.json`);
            const lotData = await response.json();
            const lotType = categoryMapping[lotData.category] || "Unknown";

            const consoleContent = document.getElementById('console-content');
            consoleContent.innerHTML = `
                <div style="text-align: center; background-color: #ff7518; padding: 10px; color: white;">
                    <h3>${lotData.name || "Unknown Lot"}</h3>
                    <p>Description: ${lotData.description || "No description available."}</p>
                    <p>Type: ${lotType}</p>
                    <p>Owner: ${lotData.owner || "Unknown"}</p>
                </div>
            `;
        }

        // Rewards population
        async function fetchRewards() {
            try {
                const response = await fetch('https://makinmagic.github.io/SimNation/rewards.json');
                const data = await response.json();
                populateRewards(data.contents);
            } catch (error) {
                console.error('Failed to load rewards:', error);
                document.getElementById('rewards-table').innerHTML = 'Failed to load rewards.';
            }
        }

        function populateRewards(htmlContent) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const options = doc.querySelectorAll('#giftSelection option');
            const rewardsContainer = document.getElementById('rewards-table').getElementsByTagName('tbody')[0];
            rewardsContainer.innerHTML = '';

            options.forEach(option => {
                const imageUrl = 'https://images.weserv.nl/?url=simnationserver.com/redeem/' + option.dataset.image;
                const row = rewardsContainer.insertRow();
                row.innerHTML = `
                    <td>${option.text}</td>
                    <td><img src="${imageUrl}" alt="${option.text}" style="width: 50px; height: 50px;"/></td>
                `;

                row.addEventListener('click', () => {
                    displayRewardInfo(option.text, imageUrl);
                });
            });
        }

        // Display reward details in the console
        function displayRewardInfo(rewardName, rewardImage) {
            const consoleContent = document.getElementById('console-content');
            consoleContent.innerHTML = `
                <div style="background-color: #ff7518; padding: 10px; color: white; text-align: center;">
                    ${rewardName}
                </div>
                <img src="${rewardImage}" alt="${rewardName}" style="width: 300px; height: 300px; display: block; margin: 20px auto;">
            `;
        }

        // Time display for Eldorado
        function tempoSim() {
            const currenttime = new Date();
            const hours = currenttime.getUTCHours();
            const minutes = currenttime.getUTCMinutes();
            const seconds = currenttime.getUTCSeconds();
            let timesuffix = "AM";
            let cycle = 0;
            if (hours % 2 === 1) {
                cycle = 3600;
                timesuffix = "PM";
            }
            cycle += minutes * 60 + seconds;
            const tsohours = Math.floor(cycle / 300) % 12 || 12;
            const tsomins = String(Math.floor((cycle % 300) / 5)).padStart(2, '0');

            document.getElementById('tempoSim').innerHTML = `Time in Eldorado: ${tsohours}:${tsomins} ${timesuffix}`;
            setTimeout(tempoSim, 1000);
        }

        // Initialize all components
        async function init() {
            tempoSim();
            await loadOnlinePlayers();
            await loadLots();
            await fetchRewards();
        }

        window.onload = init;
    </script>
</body>
</html>
